from pyrogram import Client, filters, idle
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove
from pyrogram.errors import PeerIdInvalid
from bot import bot, bot_id, db, SUDORS
import asyncio, os


def add_new_user(user_id):
	if is_user(user_id):
		return
	db.sadd(f"botusers&{bot_id}", user_id)
def is_user(user_id):
	try:
		users = get_users()
		if user_id in users:
			return True
		return False
	except:
		return False
def get_users():
	try:
		return db.get(f"botusers&{bot_id}")["set"]
	except:
		return []

def users_backup():
	text = ""
	for user in get_users():
		text += f"{user}\n"
	with open("users.txt", "w+") as f:
		f.write(text)
	return "users.txt"

def del_user(user_id: int):
	if not is_user(user_id):
		return False
	db.srem(f"botusers{bot_id}", user_id)
	return True



@bot.on_message(filters.command("start") & filters.private)
async def new_user(bot, msg):
	if not is_user(msg.from_user.id):
		add_new_user(msg.from_user.id)
		text = f"""
  â¦¿  Ø¯Ø®Ù„ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ù„Ù€.Â» Ø§Ù„Ø³ÙˆØ±Ø³

â€¢  Ø§Ù„Ø§Ø³Ù… : {msg.from_user.first_name}
â€¢ Ù…Ù†Ø´Ù† : {msg.from_user.mention}
â€¢  Ø§Ù„Ø§ÙŠØ¯ÙŠ : {msg.from_user.id}
		"""
		reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(f"Â» Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡: {len(get_users())}", callback_data= "users")]])
		if len(SUDORS) > 0:
			for user_id in SUDORS:
				await bot.send_message(int(user_id), text, reply_markup=reply_markup)
		else:
			await bot.send_message(int(SUDORS[0]), text, reply_markup=reply_markup)
			
			
@bot.on_message(filters.command("start") & filters.private, group=162728)
async def admins(bot, msg):
	if msg.from_user.id in SUDORS:
		reply_markup = ReplyKeyboardMarkup([
		    [("ØµÙ†Ø¹ Ø¨ÙˆØª"), ("Ø­Ø°Ù Ø¨ÙˆØª")],
		    [("ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ"), ("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ")],
		    [("Ø§Ù„Ø³ÙˆØ±Ø³")],
			[("Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª"), ("Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª")],
			[("ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„"), ("ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„")],			
			[("Ø§Ø°Ø§Ø¹Ù‡"),("Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡"),("Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª")],
			[("Ø¬Ù„Ø¨ Ù†Ø³Ø®Ù‡"), ("Ø±ÙØ¹ Ù†Ø³Ø®Ù‡")],
			[("Ø§Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯")],
			[("Ø§Ù„ØºØ§Ø¡")]])
		await msg.reply(f"â€¢ Ù…Ù€Ø±Ø­Ø¨Ù€Ø§  ÙŠÙ€Ø§ Ù…Ø·ÙˆØ± : {msg.from_user.mention}\nÙÙŠ Ø§Ù„ØµÙ€Ø§Ù†Ø¹ Ø§Ù„Ø®Ù€Ø§Øµ Ø¨Ø³Ù€ÙˆØ±Ø³ ÙÙŠà¢ªÙˆÙ†\nâ€” â€” â€” â€” â€” â€” â€” â€” â€”\nâ€¢ Ù…Ù€Ø¨Ø±Ù…Ø¬ Ø§Ù„Ø³Ù€ÙˆØ±Ø³ : @ToxVe\nâ€¢ Ù‚Ù†Ù€Ø§Ø© Ø§Ù„Ø³Ù€ÙˆØ±Ø³ : @Source_Veron\nØ§Ø°Ø§ Ø§Ø±Ø¯Øª ØªÙ†ØµÙŠØ¨ Ø¨ÙˆØª Ù…ÙŠÙˆØ²Ùƒ Ù‚Ù€Ù… Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù€Ù„ÙŠ Ø²Ø± Ø§ØµÙ†Ø¹ Ø¨ÙˆØª Ø¨Ø§Ù„Ø§Ø³ÙÙ„ ÙˆØ§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ù„Ùƒ", reply_markup=reply_markup, quote=True)
	else:
		reply_markup = ReplyKeyboardMarkup([
			[("ØµÙ†Ø¹ Ø¨ÙˆØª"),("Ø­Ø°Ù Ø¨ÙˆØª")],		
			[("Ø§Ù„Ø³ÙˆØ±Ø³")]])
		await msg.reply(f"â€¢ Ù…Ù€Ø±Ø­Ø¨Ù€Ø§ Ø¨Ùƒ ÙŠÙ€Ø§ : {msg.from_user.mention}\nÙÙŠ Ø§Ù„ØµÙ€Ø§Ù†Ø¹ Ø§Ù„Ø®Ù€Ø§Øµ Ø¨Ø³Ù€ÙˆØ±Ø³ ÙÙŠà¢ªÙˆÙ†\nâ€” â€” â€” â€” â€” â€” â€” â€” â€”\nâ€¢ Ù…Ù€Ø¨Ø±Ù…Ø¬ Ø§Ù„Ø³Ù€ÙˆØ±Ø³ : @ToxVe\nâ€¢ Ù‚Ù†Ù€Ø§Ø© Ø§Ù„Ø³Ù€ÙˆØ±Ø³ : @Source_Veron\nØ§Ø°Ø§ Ø§Ø±Ø¯Øª ØªÙ†ØµÙŠØ¨ Ø¨ÙˆØª Ù…ÙŠÙˆØ²Ùƒ Ù‚Ù€Ù… Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù€Ù„ÙŠ Ø²Ø± Ø§ØµÙ†Ø¹ Ø¨ÙˆØª Ø¨Ø§Ù„Ø§Ø³ÙÙ„ ÙˆØ§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ù„Ùƒ", reply_markup=reply_markup, quote=True)
	
@bot.on_message(filters.text & filters.private, group=5662)
async def cmd(bot, msg):
	if msg.from_user.id in SUDORS:
		if msg.text == "Ø§Ù„ØºØ§Ø¡":
			await msg.reply("Â» ØªÙ… Ø§Ù„ØºØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­", quote=True)
			db.delete(f"{msg.from_user.id}:fbroadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:pinbroadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:broadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:users_up:{bot_id}")
		if msg.text == "Ø§Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯":
			await msg.reply("Â» ØªÙ… Ø§Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ø±Ø³Ù„ /start Ù„Ø¹Ø±Ø¶Ù‡ Ù…Ø±Ù‡ Ø§Ø®Ø±ÙŠ", reply_markup=ReplyKeyboardRemove(selective=True), quote=True)
		if msg.text == "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„":
			if not db.get(f"{msg.from_user.id}:twasl:{bot_id}"):
				await msg.reply("Â» ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„", quote=True)
				db.set(f"{msg.from_user.id}:twasl:{bot_id}", 1)
			else:
				await msg.reply("Â» Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…ÙØ¹Ù„ Ù…Ù† Ù‚Ø¨Ù„", quote=True)
		if msg.text == "ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„":
			if db.get(f"{msg.from_user.id}:twasl:{bot_id}"):
				await msg.reply("Â» ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„", quote=True)
				db.delete(f"{msg.from_user.id}:twasl:{bot_id}")
			else:
				await msg.reply("Â» Ø§Ù„ØªÙˆØ§ØµÙ„ ØºÙŠØ± Ù…ÙØ¹Ù„", quote=True)
		if msg.text == "Ø§Ø°Ø§Ø¹Ù‡":
			await msg.reply("Â» Ø§Ø±Ø³Ù„ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ ( Ù†Øµ ØŒ Ù…Ù„Ù ØŒ Ø¬Ù‡Ù‡ Ø§ØªØµØ§Ù„ ØŒ Ù…ØªØ­Ø±ÙƒÙ‡ ØŒ Ù…Ù„ØµÙ‚ ØŒ ØµÙˆØ±Ù‡ )", quote=True)
			db.set(f"{msg.from_user.id}:broadcast:{bot_id}", 1)
			db.delete(f"{msg.from_user.id}:fbroadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:pinbroadcast:{bot_id}")
		if msg.text == "Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡":
			await msg.reply("Â» Ø§Ø±Ø³Ù„ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ ( Ù†Øµ ØŒ Ù…Ù„Ù ØŒ Ø¬Ù‡Ù‡ Ø§ØªØµØ§Ù„ ØŒ Ù…ØªØ­Ø±ÙƒÙ‡ ØŒ Ù…Ù„ØµÙ‚ ØŒ ØµÙˆØ±Ù‡ )", quote=True)
			db.set(f"{msg.from_user.id}:fbroadcast:{bot_id}", 1)
			db.delete(f"{msg.from_user.id}:pinbroadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:broadcast:{bot_id}")
		if msg.text == "Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª":
			await msg.reply("Â» Ø§Ø±Ø³Ù„ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ ( Ù†Øµ ØŒ Ù…Ù„Ù ØŒ Ø¬Ù‡Ù‡ Ø§ØªØµØ§Ù„ ØŒ Ù…ØªØ­Ø±ÙƒÙ‡ ØŒ Ù…Ù„ØµÙ‚ ØŒ ØµÙˆØ±Ù‡ )", quote=True)
			db.set(f"{msg.from_user.id}:pinbroadcast:{bot_id}", 1)
			db.delete(f"{msg.from_user.id}:fbroadcast:{bot_id}")
			db.delete(f"{msg.from_user.id}:broadcast:{bot_id}")
		if msg.text == "Ø¬Ù„Ø¨ Ù†Ø³Ø®Ù‡":
			wait = await msg.reply("Â» Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§ ..", quote=True)
			await bot.send_document(msg.chat.id, users_backup())
			await wait.delete()
			os.remove("users.txt")
		if msg.text == "Ø±ÙØ¹ Ù†Ø³Ø®Ù‡":
			await msg.reply("Â» Ø§Ø±Ø³Ù„ Ø§Ù„Ø§Ù† Ù†Ø³Ø®Ù‡ Ù…Ù„Ù Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡", quote=True)
			db.set(f"{msg.from_user.id}:users_up:{bot_id}", 1)

@bot.on_message(filters.text & filters.private)
async def cmd(bot, msg):
    if msg.from_user.id in SUDORS:
        if msg.text == "Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª":
            bots_key = f"bots&{bot_id}"
            groups_key = f"groups&{bot_id}"

            # Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙˆØªØ§Øª
            if bots_key in db:
                bots_list = db[bots_key]
                total_bots = len(bots_list)
                active_bots = len([b for b in bots_list if isinstance(b, dict) and b.get("status") == "active"])
            else:
                total_bots = 0
                active_bots = 0
            inactive_bots = total_bots - active_bots

            # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            if groups_key in db:
                total_groups = len(db[groups_key])
            else:
                total_groups = 0

            # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            total_users = len(get_users())

            stats = (
                "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\n"
                f"ğŸ‘¤ Ø¹Ø¯Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØµØ§Ù†Ø¹: {total_users}\n"
                f"ğŸ‘‘ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†: {len(SUDORS)}\n"
                f"ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙˆØªØ§Øª: {total_bots}\n"
                f"ğŸŸ¢ Ù†Ø´Ø·Ø©: {active_bots}\n"
                f"ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·Ø©: {inactive_bots}\n"
                f"ğŸ’¬ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: {total_groups}"
            )
            await msg.reply(stats)


@bot.on_message(filters.private, group=368388)
async def forbroacasts(bot, msg):
	if msg.from_user.id in SUDORS and msg.text != "Ø§Ø°Ø§Ø¹Ù‡" and msg.text != "Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡" and msg.text != "Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª" and msg.text != "Ø§Ù„ØºØ§Ø¡" and msg.text != "Ø±ÙØ¹ Ù†Ø³Ø®Ù‡" and msg.text != "â€¢ Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ â€¢" and msg.text != "ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„" and msg.text != "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„" and msg.text != "â€¢ Ø§ÙˆØ§Ù…Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ â€¢" and msg.text != "Ø§Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯" and msg.text != "Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª":
		if db.get(f"{msg.from_user.id}:broadcast:{bot_id}"):
			db.delete(f"{msg.from_user.id}:broadcast:{bot_id}")
			message = await msg.reply("â€¢ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© ..", quote=True)
			current = 1
			for user in get_users():
				try:
					await msg.copy(int(user))
					progress = (current / len(get_users())) * 100
					current += 1
					if not db.get(f"{msg.from_user.id}:flood:{bot_id}"):
						await message.edit(f"Â» Ù†Ø³Ø¨Ù‡ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ {int(progress)}%")
						db.set(f"{msg.from_user.id}:flood:{bot_id}", 1)
						db.expire(f"{msg.from_user.id}:flood:{bot_id}", 4)
				except PeerIdInvalid:
					del_user(int(user))
			await message.edit("Â» ØªÙ…Øª Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ù†Ø¬Ø§Ø­")
		if db.get(f"{msg.from_user.id}:pinbroadcast:{bot_id}"):
			db.delete(f"{msg.from_user.id}:pinbroadcast:{bot_id}")
			message = await msg.reply("Â» Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© ..", quote=True)
			current = 1
			for user in get_users():
				try:
					m = await msg.copy(int(user))
					await m.pin(disable_notification=False,both_sides=True)
					progress = (current / len(get_users())) * 100
					current += 1
					if not db.get(f"{msg.from_user.id}:flood:{bot_id}"):
						await message.edit(f"Â» Ù†Ø³Ø¨Ù‡ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ {int(progress)}%")
						db.set(f"{msg.from_user.id}:flood:{bot_id}", 1)
						db.expire(f"{msg.from_user.id}:flood:{bot_id}", 4)
				except PeerIdInvalid:
					del_user(int(user))
			await message.edit("Â» ØªÙ…Øª Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ù†Ø¬Ø§Ø­")
		if db.get(f"{msg.from_user.id}:fbroadcast:{bot_id}"):
			db.delete(f"{msg.from_user.id}:fbroadcast:{bot_id}")
			message = await msg.reply("Â» Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© ..", quote=True)
			current = 1
			for user in get_users():
				try:
					await msg.forward(int(user))
					progress = (current / len(get_users())) * 100
					current += 1
					if not db.get(f"{msg.from_user.id}:flood:{bot_id}"):
						await message.edit(f"â€¢ Ù†Ø³Ø¨Ù‡ Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ {int(progress)}%")
						db.set(f"{msg.from_user.id}:flood:{bot_id}", 1)
						db.expire(f"{msg.from_user.id}:flood:{bot_id}", 4)
				except PeerIdInvalid:
					del_user(int(user))
			await message.edit("Â» ØªÙ…Øª Ø§Ù„Ø§Ø°Ø§Ø¹Ù‡ Ø¨Ù†Ø¬Ø§Ø­")
	if msg.document and db.get(f"{msg.from_user.id}:users_up:{bot_id}"):
		message = await msg.reply(f"Â» Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§ ..", quote=True)
		await msg.download("./users.txt")
		db.delete(f"botusers{bot_id}")
		file = open("./users.txt", "r", encoding="utf8", errors="ignore")
		for user in file.read().splitlines():
			if not is_user(user):
				add_new_user(user)
		await message.edit(f"â€¢ ØªÙ… Ø±ÙØ¹ Ù†Ø³Ø®Ù‡ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡ \nâ€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡ : {len(get_users())}")
		try:
			os.remove("./users.txt")
			db.delete(f"{msg.from_user.id}:users_up:{bot_id}")
		except:
			pass
@bot.on_message(filters.private, group=793874)
async def twasl(bot, msg):
	if msg.from_user.id not in SUDORS:
		for user in SUDORS:
			if db.get(f"{user}:twasl:{bot_id}"):
				await msg.forward(user)
	if msg.from_user.id in SUDORS:
		if msg.reply_to_message:
			if msg.reply_to_message.forward_from:
				try:
					await msg.copy(msg.reply_to_message.forward_from.id)
					await msg.reply(f"â€¢ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ {msg.reply_to_message.forward_from.first_name}\nâ€¢ Ø¨Ù†Ø¬Ø§Ø­", quote=True)
				except Exception as Error:
					await msg.reply(f"â€¢ Ù„Ù… ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ø³Ø¨Ø¨: {str(Error)}", quote=True)
					pass
